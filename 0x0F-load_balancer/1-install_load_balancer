#!/usr/bin/env bash

# Install HAProxy if not already installed
if ! dpkg -l | grep -q haproxy; then
    # Add HAProxy PPA
    sudo apt-get -y install software-properties-common
    sudo add-apt-repository -y ppa:vbernat/haproxy-2.5
    sudo apt-get -y update
    sudo apt-get -y install haproxy

    # Enable HAProxy
    aENABLED="ENABLED=1"
    sudo sed -i -e "\$a$aENABLED" /etc/default/haproxy
fi

# Configure HAProxy
sudo tee /etc/haproxy/haproxy.cfg <<EOF
frontend http_front
    bind *:80
    mode http
    default_backend http_back

backend http_back
    mode http
    balance roundrobin
    server web-01 34.207.156.22:80 check
    server web-02 52.91.153.42:80 check
EOF

# Restart HAProxy to apply the changes
sudo service haproxy restart

# Configure Nginx to add a custom header
sudo sed -i '/server_name _;/a \        add_header X-Served-By $hostname;' /etc/nginx/sites-available/default

# Restart Nginx to apply the changes
sudo service nginx restart

# Exit script
exit 0

